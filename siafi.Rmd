---
title: "siafi"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---


```{r}
options(scipen=999)
options(digits=2)
```


```{r include=FALSE}
library(flexdashboard)
library(readxl)
library(ggplot2)
library(stringr)
library(plotly)
library(DT)
library(knitr)
library(shiny)
# library(shinyWidgets)
library(lubridate)
library(tidyverse)
library(janitor)
library(scales)
library(readr)
library(highcharter)
# library(googledrive)
library(googlesheets4)
library(esquisse)
library(ggeasy)
library(ggx)
```

```{r negar %in%}
# https://www.r-bloggers.com/the-notin-operator/
'%!in%' <- Negate('%in%')
```

```{r}
tabela_reais = function (df,coluna = NULL) {
      datatable((df)%>%
  # "row" para o total aparecer na linha, ou seja, totalizar os valores de uma coluna
  adorn_totals("row") ,
      filter = 'top', 
      rownames = FALSE,
      extensions = 'Buttons',
      options = list( 
                  # order = list (df[(length(df))], 'desc'),
                  dom = "Blfrtip",
                  buttons = 
                    list("copy", list(
                      extend = "collection",
                      buttons = c("csv", "excel", "pdf"),
                      text = "Download" ) ),
                  lengthMenu = list( c(-1, 5, 10,20),
                                     c( "tudo",5, 10, 20)),
                  pageLength = -1 )
      )%>%
  formatRound(
  # formatar apenas as colunas numericas.
  # sapply para identificar as colunas numericas e combinar com o parametro COLUNA
    # ((ncol(df %>% select_if(is.character))+1):(ncol(df )+1)),
    # http://datamining.togaware.com/survivor/Remove_Non_Numeric.html
    (c(colnames(df[,sapply(df, is.numeric)]), coluna)),
  digits = 2,
  interval = 3,
  mark = ".",
  dec.mark = ","
) 
}
```
Importar remuneracao dos servidores, filtrar apenas os ordenadores de despesa e salvar arquivo para deixar o processamento mais leve

Tarefa: criar funcao para importar, criar variavel cpf_nome

```{r eval=FALSE, include=FALSE}


militares <- read_excel("202112_militares.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))
civis <- read_excel("202112_civis.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))
bacen <- read_excel("202112_bacen.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))



militares <- militares %>% filter(cpf_nome %in% ordenador$cpf_nome)

civis <- civis %>% filter(cpf_nome %in% ordenador$cpf_nome)


bacen <- bacen %>% filter(cpf_nome %in% ordenador$cpf_nome)

servidores <- rbind(militares, civis, bacen)

write_csv(servidores, "servidores_202112.csv")







```

Importar cadastro dos servidores, filtrar apenas os ordenadores de despesa e salvar arquivo para deixar o processamento mais leve


```{r eval=FALSE, include=FALSE}



militares_cadastro <- read_excel("202112_militares_cadastro.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))
civis_cadastro <- read_excel("202112_civis_cadastro.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))
bacen_cadastro <- read_excel("202112_bacen_cadastro.xlsx")%>% mutate (cpf_nome = str_c(CPF,NOME))



militares_cadastro <- militares_cadastro %>% filter(cpf_nome %in% ordenador$cpf_nome)

civis_cadastro <- civis_cadastro%>% filter(cpf_nome %in% ordenador$cpf_nome)


bacen_cadastro <- bacen_cadastro %>% filter(cpf_nome %in% ordenador$cpf_nome)

cadastro <- rbind(militares_cadastro, civis_cadastro, bacen_cadastro)

write_csv(cadastro, "cadastro_202112.csv")

```



```{r}
servidores <- read_csv("servidores_202112.csv")



servidores <- servidores %>% select(cpf_nome,`REMUNERAÇÃO BÁSICA BRUTA (R$)`,`REMUNERAÇÃO BÁSICA BRUTA (U$)`) %>% mutate(remuneracao =`REMUNERAÇÃO BÁSICA BRUTA (R$)`+ 5*`REMUNERAÇÃO BÁSICA BRUTA (U$)` )


cadastro <- read_csv("cadastro_202112.csv")

cadastro <- cadastro %>% mutate(cpf_nome_uorg = str_c(cpf_nome, UORG_EXERCICIO)) %>% mutate(cpf_nome_uorg_jornada = str_c(cpf_nome_uorg,JORNADA_DE_TRABALHO))

cadastro <- cadastro  %>% select(cpf_nome,NOME,DESCRICAO_CARGO,UORG_LOTACAO,ORG_LOTACAO, TIPO_VINCULO, SITUACAO_VINCULO ,SIGLA_FUNCAO,NIVEL_FUNCAO,FUNCAO,UORG_EXERCICIO,JORNADA_DE_TRABALHO, cpf_nome_uorg)

cadastro <- cadastro %>% filter(SITUACAO_VINCULO != "SEM VINCULO")

# multiplos_vinculos <- (cadastro %>% group_by(cpf_nome) %>% count()) %>% filter (n ==3)
# 
# multiplos_vinculos_filtro <- (cadastro %>% group_by(cpf_nome, UORG_EXERCICIO) %>% count()) %>% filter (cpf_nome %in% multiplos_vinculos$cpf_nome, n ==1 )
# 
# multiplos_vinculos_filtro <- multiplos_vinculos_filtro %>% mutate(cpf_nome_uorg = str_c(cpf_nome, UORG_EXERCICIO))
# 
# cadastro <- cadastro %>% filter(cpf_nome_uorg %!in% multiplos_vinculos_filtro$cpf_nome_uorg)
# 
# datatable(cadastro %>% group_by(cpf_nome_uorg,JORNADA_DE_TRABALHO) %>% summarise(max(JORNADA_DE_TRABALHO)) %>% count() %>% filter(n==2))
# 
# servidores_multiplos_vinculos <- cadastro %>% filter(cpf_nome %in% multiplos_vinculos$cpf_nome)
# 
# datatable(servidores_multiplos_vinculos %>% group_by(FUNCAO) %>% count())


cadastro_funcao <- cadastro %>% filter(FUNCAO %!in% c("Sem informação", NA) ) %>% select(NOME, FUNCAO, SIGLA_FUNCAO, NIVEL_FUNCAO)
cadastro_cargo <- cadastro %>% filter(FUNCAO == "Sem informação" ) %>% select ( -FUNCAO,- SIGLA_FUNCAO, -NIVEL_FUNCAO)
cadastro_servidor <- full_join(cadastro_cargo,cadastro_funcao)


cadastro_funcao_comissionado <- cadastro %>% filter(SITUACAO_VINCULO == "NOMEADO CARGO COMIS.") %>% select(NOME, FUNCAO, SIGLA_FUNCAO, NIVEL_FUNCAO)
cadastro_cargo_comissionado <- cadastro %>% filter(SITUACAO_VINCULO == "NOMEADO CARGO COMIS.") %>% select ( -FUNCAO,- SIGLA_FUNCAO, -NIVEL_FUNCAO)
cadastro_servidor_comissionado <- full_join(cadastro_cargo_comissionado,cadastro_funcao_comissionado)


cadastro_funcao_faltantes <- cadastro %>% filter(cpf_nome %in% faltantes, UORG_LOTACAO != "SERV APOIO DIAGNOSTICO E TERAPEUTICO") %>% select(NOME, FUNCAO, SIGLA_FUNCAO, NIVEL_FUNCAO)
cadastro_cargo_faltantes <- cadastro %>%  filter(cpf_nome %in% faltantes, UORG_LOTACAO != "SERV APOIO DIAGNOSTICO E TERAPEUTICO") %>% select ( -FUNCAO,- SIGLA_FUNCAO, -NIVEL_FUNCAO)
cadastro_servidor_faltantes <- full_join(cadastro_funcao_faltantes,cadastro_cargo_faltantes)


cadastro_geral <- rbind(cadastro_servidor,cadastro_servidor_comissionado)



# cadastro_geral <-  cadastro_geral %>% mutate(cpf_nome_lotacao = str_c(cpf_nome,"-",UORG_LOTACAO)) 
# 
# cadastro_geral <- cadastro_geral %>% mutate(cpf_nome_uorg_jornada = str_c(cpf_nome_uorg,JORNADA_DE_TRABALHO))
# 
#  cadastro_geral <- cadastro_geral %>% mutate(cpf_nome_uorg_jornada = str_c(cpf_nome_uorg,JORNADA_DE_TRABALHO))
 
#  dupla_jornada_filtro <- (cadastro_geral %>% group_by(cpf_nome,JORNADA_DE_TRABALHO) %>% summarise(max(JORNADA_DE_TRABALHO)) %>% count() %>% filter(n==1))
#  
#  dupla_jornada <- cadastro_geral %>% filter(cpf_nome_uorg %in% dupla_jornada_filtro$cpf_nome_uorg) %>% select(cpf_nome_uorg,DESCRICAO_CARGO,FUNCAO,UORG_EXERCICIO,JORNADA_DE_TRABALHO) %>% mutate(jornada = case_when(
#   JORNADA_DE_TRABALHO == "20 HORAS SEMANAIS" ~ 20,
#   JORNADA_DE_TRABALHO == "40 HORAS SEMANAIS" ~ 40,
#   JORNADA_DE_TRABALHO == "44 HORAS SEMANAIS" ~ 44,
#   JORNADA_DE_TRABALHO == "DEDICACAO EXCLUSIVA" ~ 60
# ))
# 
#  
#  jornada <- dupla_jornada %>% group_by(cpf_nome_uorg) %>% summarise(JORNADA_DE_TRABALHO= min(JORNADA_DE_TRABALHO)) %>% mutate(cpf_nome_uorg_jornada = str_c(cpf_nome_uorg,JORNADA_DE_TRABALHO))
# 
#  
#  cadastro_geral <- cadastro_geral %>% filter(cpf_nome_uorg_jornada %!in% jornada$cpf_nome_uorg_jornada)
# 
# jornada_dupla_fase_2 <- (cadastro_geral %>% group_by(cpf_nome) %>% count()) %>% filter(n==2)
# 
# 
# datatable(cadastro_geral %>% filter (cpf_nome %in% jornada_dupla_fase_2$cpf_nome) %>% group_by(cpf_nome_uorg_jornada,cpf_nome_lotacao) %>% count())
# 
# cpf_nome_cargo <- (cadastro_geral %>% filter (cpf_nome %in% jornada_dupla_fase_2$cpf_nome) %>% group_by(cpf_nome_uorg_jornada,DESCRICAO_CARGO,cpf_nome_lotacao) %>% count())
# 
# cpf_nome_cargo_filtro <- cpf_nome_cargo %>% filter(DESCRICAO_CARGO %in% c("Inválido", "PROFESSOR DO MAGISTERIO SUPERIOR")) %>% mutate (cpf_nome_cargo = str_c (cpf_nome_uorg_jornada, DESCRICAO_CARGO))
# 
cadastro_geral <- cadastro_geral  %>% mutate (cpf_nome_cargo = str_c (cpf_nome_uorg_jornada, DESCRICAO_CARGO))
# 
cadastro_geral <-  cadastro_geral %>% filter(cpf_nome_cargo %!in% cpf_nome_cargo_filtro$cpf_nome_cargo)

```

```{r include=FALSE}

# identificar servidores com multiplos vínculos
cpf_duplicado <- cadastro_geral %>% group_by(cpf_nome) %>% count()

cpf_duplicado <- cpf_duplicado %>% filter(n >1)

cpf_duplicado <- cadastro_geral %>% filter(cpf_nome %in% cpf_duplicado$cpf_nome)

# cpf_duplicado <- cpf_duplicado %>% select(cpf_nome, cpf_nome_uorg, cpf_nome_uorg_jornada, FUNCAO, SITUACAO_VINCULO,DESCRICAO_CARGO, UORG_LOTACAO, UORG_EXERCICIO, JORNADA_DE_TRABALHO)

# eliminar registro duplicados a partir de UORG_EXERCICIO Sem Informação ou Inválido
cpf_duplicado_uorg_filtro <- cpf_duplicado %>% filter(UORG_EXERCICIO %in% c("Sem informação", "Inválido"))

cadastro_geral <- cadastro_geral %>% filter(cpf_nome_uorg %!in% cpf_duplicado_uorg_filtro$cpf_nome_uorg)

# repetir o processo de depuração

cpf_duplicado_fase_2 <- cadastro_geral %>% group_by(cpf_nome) %>% count()

cpf_duplicado_fase_2 <- cpf_duplicado_fase_2 %>% filter(n >1)

cpf_duplicado_fase_2 <- cadastro_geral %>% filter(cpf_nome %in% cpf_duplicado_fase_2$cpf_nome)




cpf_duplicado_fase_2 <-  cpf_duplicado_fase_2 %>% mutate(jornada = case_when(
  JORNADA_DE_TRABALHO == "12 HORAS SEMANAIS" ~ 12,
  JORNADA_DE_TRABALHO == "20 HORAS SEMANAIS" ~ 20,
  JORNADA_DE_TRABALHO == "24 HORAS SEMANAIS" ~ 24,
  JORNADA_DE_TRABALHO == "40 HORAS SEMANAIS" ~ 40,
  JORNADA_DE_TRABALHO == "44 HORAS SEMANAIS" ~ 44,
  JORNADA_DE_TRABALHO == "DEDICACAO EXCLUSIVA" ~ 60,
  JORNADA_DE_TRABALHO == "DSPN. PERMANENTE" ~ 60
)) %>% 
  mutate(lotacao = case_when(
  UORG_LOTACAO == "Inválido" ~ 0,
  UORG_LOTACAO == "Sem informação" ~ 0,
  TRUE ~ 10
)) %>% 
  mutate(uorg_jornada = (jornada+lotacao))

cpf_duplicado_fase_2 <-cpf_duplicado_fase_2 %>%  mutate (cpf_nome_lotacao = str_c(cpf_nome, UORG_LOTACAO)) %>% mutate(cpf_nome_professor = str_c(cpf_nome,DESCRICAO_CARGO))

cpf_duplicado_fase_2 <- cpf_duplicado_fase_2 %>% filter(startsWith(DESCRICAO_CARGO, "PROFESSOR") )

cadastro_geral <- cadastro_geral %>% mutate(cpf_nome_professor = str_c(cpf_nome,DESCRICAO_CARGO))

cadastro_geral <- cadastro_geral %>% filter(cpf_nome_professor %!in% cpf_duplicado_fase_2$cpf_nome_professor)

# repetir o processo de depuração

cpf_duplicado_fase_3 <- cadastro_geral %>% group_by(cpf_nome) %>% count()

cpf_duplicado_fase_3 <- cpf_duplicado_fase_3 %>% filter(n >1)

cpf_duplicado_fase_3 <- cadastro_geral %>% filter(cpf_nome %in% cpf_duplicado_fase_3$cpf_nome)


cpf_duplicado_fase_3 <- cpf_duplicado_fase_3 %>% filter(DESCRICAO_CARGO %in% c("TECNOLOGISTA", "Inválido")) 

cadastro_geral <- cadastro_geral%>% filter(cpf_nome_professor %!in% cpf_duplicado_fase_3$cpf_nome_professor)


faltantes <- setdiff(unique(cadastro$cpf_nome),cadastro_geral$cpf_nome)

cadastro_funcao_faltantes <- cadastro %>% filter(cpf_nome %in% faltantes, UORG_LOTACAO != "SERV APOIO DIAGNOSTICO E TERAPEUTICO") %>% select(NOME, FUNCAO, SIGLA_FUNCAO, NIVEL_FUNCAO)
cadastro_cargo_faltantes <- cadastro %>%  filter(cpf_nome %in% faltantes, UORG_LOTACAO != "SERV APOIO DIAGNOSTICO E TERAPEUTICO") %>% select ( -FUNCAO,- SIGLA_FUNCAO, -NIVEL_FUNCAO)
cadastro_servidor_faltantes <- full_join(cadastro_funcao_faltantes,cadastro_cargo_faltantes)

cadastro_geral <- rbind(cadastro_geral %>% select(cpf_nome,NOME,DESCRICAO_CARGO,UORG_LOTACAO,ORG_LOTACAO, TIPO_VINCULO, SITUACAO_VINCULO ,SIGLA_FUNCAO,NIVEL_FUNCAO,FUNCAO,UORG_EXERCICIO,JORNADA_DE_TRABALHO, cpf_nome_uorg), cadastro_servidor_faltantes %>% select(cpf_nome,NOME,DESCRICAO_CARGO,UORG_LOTACAO,ORG_LOTACAO, TIPO_VINCULO, SITUACAO_VINCULO ,SIGLA_FUNCAO,NIVEL_FUNCAO,FUNCAO,UORG_EXERCICIO,JORNADA_DE_TRABALHO, cpf_nome_uorg))

( setdiff(unique(cadastro$cpf_nome),cadastro_geral$cpf_nome))
( setdiff(cadastro_geral$cpf_nome,unique(cadastro$cpf_nome)))


pessoal <- left_join(servidores, cadastro_geral)

```



Tarefa: alterar consulta da tabela de ordenadores para trazer apenas ug e ordenador.

```{r}
ordenador <- read_excel("ug_202112.xlsx",     skip = 5)

ordenador <- ordenador %>% mutate(CPF = str_c("***.",str_sub(`UGE - Ordenador - Responsável Número`,start = 4L, end = -6L),".",str_sub(`UGE - Ordenador - Responsável Número`,start = 7L, end = -3L),"-**"))

ordenador <- ordenador  %>% mutate (cpf_nome = str_c(CPF,`UGE - Ordenador - Responsável Nome`))

ordenador <- ordenador %>% group_by(`UGE - Ordenador - Responsável Nome`,cpf_nome,`UG Executora Código`,`UG Executora Nome`,`UG Executora Nome Reduzido`,`UGE - Município Nome`,`UGE - UF Sigla`,`UGE - UF Nome`) %>% count()




```



Tarefa: criar relatorio com ug, orgao, poder, ativo, passivo, receita e despesa

```{r}
ug_conta <- read_excel("ug_conta.xlsx", skip = 7) %>% filter(ATIVO != 0 & `PASSIVO E PATRIMONIO LIQUIDO` != 0) 
ug_conta[is.na(ug_conta)] <- 0

ug_orc <- read_excel("ug_receita_despesa.xlsx",     skip = 7)
ug_orc <- ug_orc %>% select(-`Item Informação`)
ug_orc <- ug_orc %>% mutate_at(vars(c(`RECEITA ORCAMENTARIA (BRUTA)`,`PAGAMENTOS TOTAIS (EXERCICIO E RAP)`)), ~replace_na(.,0))

ug_conta_orc <- full_join(ug_conta,ug_orc, by = "UG Executora Código")



```

Tarefa: mesclar ou vincular tabelas
Eliminar duplicidade de vinculos na tabela cadastro

```{r}
ugs <- left_join(ug_conta_org, ordenador %>% select(-`UG Executora Nome`))
ugs <- left_join(ugs, ug_conta %>% select(-`UG Executora Nome`))

ugs <- left_join(ugs, servidores)

ugs <- left_join(ugs, cadastro_servidor )

funcao <- servidores_multiplos_vinculos %>% group_by(cpf_nome,FUNCAO, UORG_LOTACAO) %>% count() %>%  mutate(cpf_nome_lotacao = str_c(cpf_nome,"-",UORG_LOTACAO))

funcao_sem_info <- funcao %>% filter(FUNCAO == "Sem informação")


# ugs <- ugs %>% mutate (ug_code = as.numeric(`UG Executora Código`))
# 
# 
# 
# ugs <- left_join(ugs, siafi_ugs)

# datatable(ugs %>% filter(is.na(ATIVO)) %>% group_by(orgao, `UG Executora Nome`,ATIVO,`PAGAMENTOS TOTAIS (EXERCICIO E RAP)`) %>% count())
datatable(cadastro_cargo %>% filter(JORNADA_DE_TRABALHO != c("20 HORAS SEMANAIS","24 HORAS SEMANAIS"), !startsWith(DESCRICAO_CARGO, "PROF") ) %>% group_by(NOME)  %>% count())
```



```{r eval=FALSE, include=FALSE}
siafi_usuarios <- read_csv("siafidadosusuarios2.csv")


names(siafi_usuarios) <- c("CPF", "usuario", "ug_code", "ug", "orgao_code", "orgao", "nivel", "situacao")


siafi_usuarios <- siafi_usuarios %>% mutate(ug_code = as.double(ug_code))

```
```{r eval=FALSE, include=FALSE}
siafi_ugs <- read_csv("siafirelatoriounidadesgestoras.csv")

names(siafi_ugs) <- c( "ug_code", "ug","cnpj_ug","UF", "orgao_code", "orgao", "cnpj-orgao","funcao", "ativo", "cep", "endereco")

siafi_ugs <- siafi_ugs %>% mutate(ug_code = as.double(ug_code))


siafi <- left_join ( siafi_usuarios %>% select(usuario,ug_code,nivel, situacao), siafi_ugs, c ("ug_code"="ug_code"))
```


```{r eval=FALSE, include=FALSE}
retencao_federal <- read_excel("retencao_federal.xlsx")

retencao_federal <- retencao_federal %>% mutate(ug_code = as.double(ug_code))

retencao_federal_ug <- retencao_federal %>% group_by(ug_code) %>% summarise(valor = sum(valor))


datatable( retencao_federal %>% group_by(ug, ug_code) %>% count())
```
Row
-----------------------------------------------------------------------
### orgaos



```{r}
ug_conta_2 <- read_excel("ug_conta_2.xlsx", skip = 7) %>% filter(ATIVO != 0 & `PASSIVO E PATRIMONIO LIQUIDO` != 0) 
ug_conta_2[is.na(ug_conta_2)] <- 0

ug_orc_2 <- read_excel("ug_orc_2.xlsx",     skip = 7)
ug_orc_2 <- ug_orc_2 %>% select(-`Item Informação`)
ug_orc_2 <- ug_orc_2 %>% mutate_at(vars(c(`RECEITA ORCAMENTARIA (BRUTA)`,`PAGAMENTOS TOTAIS (EXERCICIO E RAP)`)), ~replace_na(.,0))

ug_conta_orc_2 <- full_join(ug_conta_2,ug_orc_2, by = "UG Executora Código")
```



